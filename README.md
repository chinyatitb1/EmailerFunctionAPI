# Email Sender API (FastAPI)
## Overview

The Email Sender API is a lightweight HTTP service built with FastAPI that allows applications to send emails with attachments through SMTP.

It is designed to support both:

- **Automated systems** (Logic Apps, pipelines, backend services) using Base64 payloads

- **Manual testing and ad-hoc use** using file uploads

The service includes built-in OpenAPI/Swagger documentation, API key authentication, and is deployable on Azure App Service (Linux) without requiring Azure API Management.

## Key Capabilities

Send emails with any attachment type (PDF, MHTML, ZIP, CSV, etc.)

Two attachment modes:

Base64 JSON (automation-friendly)

Multipart file upload (manual testing)

API key–secured endpoints

Admin-managed API key lifecycle (create, list, revoke)

OpenAPI / Swagger documentation out of the box

Works locally and on Azure App Service

SMTP-based delivery (Gmail, Outlook, or organizational relay)

## High-Level Architecture
+------------------+        HTTP Request        +----------------------+
| Client App /     |  ---------------------->  |  Email Sender API     |
| Logic App / Job  |                            |  (FastAPI)            |
+------------------+                            |----------------------|
                                                | - API Key Validation  |
                                                | - Attachment Handling |
                                                | - Swagger Docs        |
                                                | - SMTP Client         |
                                                +----------+-----------+
                                                           |
                                                           | SMTP
                                                           v
                                                +----------------------+
                                                |  SMTP Server         |
                                                |  (Gmail / Outlook /  |
                                                |   Org Relay)         |
                                                +----------------------+
## Project Structure
email-api/
├── app.py              # FastAPI application
├── requirements.txt    # Python dependencies
├── README.md           # Documentation

##Requirements
- Python 3.10 or newer
- An SMTP-capable email account (Gmail, Outlook, or relay)
- Azure App Service (Linux) for cloud deployment

## Local Setup
**1. Clone the repository**
git clone https://github.com/<your-org>/email-api.git
cd email-api

**2. Create and activate a virtual environment**
python -m venv .venv
.venv\Scripts\Activate
pip install -r requirements.txt

**3. Configure environment variables**

Example configuration using Gmail SMTP:

$env:SMTP_HOST="smtp.gmail.com"
$env:SMTP_PORT="587"
$env:SMTP_USE_TLS="true"
$env:SMTP_USER="your@gmail.com"
$env:SMTP_PASS="GMAIL_APP_PASSWORD"
$env:FROM_EMAIL="your@gmail.com"

# Admin key used to manage client API keys
$env:ADMIN_KEY="strong-admin-key"


Notes:
- Gmail requires an App Password (not your normal account password)
- Do not commit secrets to source control

**4. Run the API locally**
python -m uvicorn app:app --host 0.0.0.0 --port 8000

Swagger UI will be available at:
http://localhost:8000/docs

## Authentication Model
### Admin Key

Stored as an environment variable (ADMIN_KEY)

Used to manage client API keys

Can be rotated without redeploying the application

### Client API Keys

Generated by an admin

Stored hashed (SHA-256) in SQLite

Passed via HTTP header:

X-API-Key: <client-key>

## API Key Management
### Create a client API key
Invoke-RestMethod -Method Post `
  -Uri http://localhost:8000/keys `
  -Headers @{ "X-Admin-Key" = "strong-admin-key" } `
  -ContentType application/json `
  -Body '{ "name": "logic-app" }'

The raw API key is returned once and must be stored securely.

## List existing API keys
GET /keys
X-Admin-Key: <admin-key>

## Revoke an API key
DELETE /keys/{key_id}
X-Admin-Key: <admin-key>

## Sending Emails
**1. Send email using Base64 JSON (automation)**

Endpoint:

POST /send-json


Headers:

X-API-Key: <client-key>


Request body:

{
  "to": ["user@example.com"],
  "cc": [],
  "subject": "Daily Report",
  "htmlBody": "<p>Please find the report attached.</p>",
  "attachments": [
    {
      "name": "DailyReport.mhtml",
      "contentType": "application/x-mhtml",
      "contentBase64": "<base64-encoded-content>"
    }
  ]
}


This mode is ideal for Logic Apps, batch jobs, and backend services.

**2. Send email using file upload (manual testing)**

Endpoint:

POST /send-upload


Headers:

X-API-Key: <client-key>


Form fields:

to – comma-separated email addresses

subject

htmlBody

files[] – one or more files

This endpoint is fully usable from Swagger UI.

## Health Check

Endpoint:

GET /health


Response:

{ "ok": true }

## Azure App Service Deployment
### App Service Configuration

Operating System: Linux

Runtime Stack: Python 3.11

Startup Command:

python -m uvicorn app:app --host 0.0.0.0 --port 8000

## Required Application Settings
SMTP_HOST
SMTP_PORT
SMTP_USE_TLS
SMTP_USER
SMTP_PASS
FROM_EMAIL
ADMIN_KEY
SCM_DO_BUILD_DURING_DEPLOYMENT=1
API_DB_PATH=/home/site/data/api.db


Notes:

- /home/site/data is the writable directory on Linux App Service
- Changing app settings triggers a restart

# Operational Considerations
## SMTP Restrictions

Some Azure environments restrict outbound SMTP traffic.

If SMTP fails in Azure:

Use an organizational SMTP relay with allow-listed Azure IPs

Or switch to a managed email provider (e.g., Azure Communication Services)

## Persistence and Scaling

- SQLite is suitable for single-instance deployments

- For scale-out scenarios, move API key storage to:

- Azure SQL / PostgreSQL

- Cosmos DB

- Redis

## Security Notes

API keys are hashed at rest

Admin key is never stored in code

Secrets are injected via environment variables

Attachment size limits are enforced

Suitable for internal and controlled external use

## License

MIT License 

## Maintainer

Tinashe Chinyati
Senior Data Engineer / Cloud Engineer
